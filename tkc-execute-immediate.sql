CLEAR SCREEN

DECLARE
    s clob;
BEGIN
    s:='WITH CTE000 AS (SELECT EID FROM EADV GROUP BY EID),
CTE001 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE (ATT = ``eGFR``)),
CTE002 AS (SELECT EID,VAL AS egfrlv FROM CTE001 WHERE rank=1),
CTE003 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE (ATT = ``ACR``)),
CTE004 AS (SELECT EID,VAL AS acrlv FROM CTE003 WHERE rank=1),
CTE005 AS (SELECT EID,MAX(DT) AS egfrld  FROM EADV WHERE (ATT = ``eGFR``) GROUP BY EID),
CTE006 AS (SELECT EID,MAX(DT) AS acrld  FROM EADV WHERE (ATT = ``ACR``) GROUP BY EID),
CTE007 AS (SELECT EID,COUNT(VAL) AS sbp140cnt  FROM EADV WHERE (ATT = ``SYSTOLIC``) AND VAL>140 GROUP BY EID),
CTE008 AS (SELECT EID,MAX(DT) AS hd_icd  FROM EADV WHERE (ATT = ``icd_Z49_1``) GROUP BY EID),
CTE009 AS (SELECT EID,MAX(DT) AS hd_icpc  FROM EADV WHERE (ATT = ``U59001``) OR (ATT = ``U59008``) GROUP BY EID),
CTE010 AS (SELECT EID,MAX(DT) AS hd_proc  FROM EADV WHERE (ATT = ``1310000``) GROUP BY EID),
CTE011 AS (SELECT EID,MAX(DT) AS hdld  FROM EADV WHERE (ATT = ``1310000``) OR (ATT = ``U59001``) OR (ATT = ``U59008``) OR (ATT = ``icd_Z49_1``) GROUP BY EID),
CTE012 AS (SELECT EID,MAX(DT) AS pd_icpc  FROM EADV WHERE (ATT = ``U59007``) OR (ATT = ``U59009``) GROUP BY EID),
CTE013 AS (SELECT EID,MAX(DT) AS pd_icd  FROM EADV WHERE (ATT = ``icd_Z49_2``) GROUP BY EID),
CTE014 AS (SELECT EID,MAX(DT) AS pd_proc  FROM EADV WHERE (ATT = ``1310006``) OR (ATT = ``1310007``) OR (ATT = ``1310008``) GROUP BY EID),
CTE015 AS (SELECT EID,MAX(DT) AS pdld  FROM EADV WHERE (ATT = ``1310006``) OR (ATT = ``1310007``) OR (ATT = ``1310008``) OR (ATT = ``U59007``) OR (ATT = ``U59009``) OR (ATT = ``icd_Z49_2``) GROUP BY EID),
CTE016 AS (SELECT EID,MAX(DT) AS tx_icpc  FROM EADV WHERE (ATT = ``U28001``) GROUP BY EID),
CTE017 AS (SELECT EID,MAX(DT) AS tx_icd  FROM EADV WHERE (ATT LIKE ``icd_Z94%``) GROUP BY EID),
CTE018 AS (SELECT EID,MAX(DT) AS tx_proc  FROM EADV WHERE (ATT = ``1310006``) OR (ATT = ``1310007``) OR (ATT = ``1310008``) GROUP BY EID),
CTE019 AS (SELECT EID,MAX(DT) AS txld  FROM EADV WHERE (ATT = ``U28001``) OR (ATT LIKE ``icd_Z94%``) GROUP BY EID),
CTE020 AS (SELECT EID,MAX(DT) AS hhd  FROM EADV WHERE (ATT = ``U59J99``) GROUP BY EID),
CTE021 AS (SELECT EID,MAX(DT) AS hhdld  FROM EADV WHERE (ATT = ``U59J99``) GROUP BY EID),
CTE022 AS (SELECT CASE WHEN egfrlv>=90 THEN ``G1`` WHEN egfrlv<90 AND egfrlv>=60 THEN ``G2`` WHEN egfrlv<60 AND egfrlv>=45 THEN ``G3A`` WHEN egfrlv<45 AND egfrlv>=30 THEN ``G3B`` WHEN egfrlv<30 AND egfrlv>=15 THEN ``G4`` WHEN egfrlv<15 THEN ``G5`` ELSE ``NA`` END AS CGA_G,CTE000.EID  FROM CTE000 LEFT OUTER JOIN CTE002 ON CTE002.EID=CTE000.EID  LEFT OUTER JOIN CTE004 ON CTE004.EID=CTE000.EID ),
CTE023 AS (SELECT CASE WHEN acrlv<3 THEN ``A1`` WHEN acrlv<30 AND acrlv>=3 THEN ``A2`` WHEN acrlv<300 AND acrlv>=30 THEN ``A3`` WHEN acrlv>300 THEN ``A4`` ELSE ``NA`` END AS CGA_A,CTE000.EID  FROM CTE000 LEFT OUTER JOIN CTE004 ON CTE004.EID=CTE000.EID )
 SELECT CTE000.EID, CTE002.egfrlv 
,CTE004.acrlv 
,CTE005.egfrld 
,CTE006.acrld 
,CTE007.sbp140cnt 
,CTE008.hd_icd 
,CTE009.hd_icpc 
,CTE010.hd_proc 
,CTE011.hdld 
,CTE012.pd_icpc 
,CTE013.pd_icd 
,CTE014.pd_proc 
,CTE015.pdld 
,CTE016.tx_icpc 
,CTE017.tx_icd 
,CTE018.tx_proc 
,CTE019.txld 
,CTE020.hhd 
,CTE021.hhdld 
,CTE022.cga_g 
,CTE023.cga_a 
FROM CTE000 LEFT OUTER JOIN CTE002 ON CTE002.EID=CTE000.EID 
 LEFT OUTER JOIN CTE004 ON CTE004.EID=CTE000.EID 
 LEFT OUTER JOIN CTE005 ON CTE005.EID=CTE000.EID 
 LEFT OUTER JOIN CTE006 ON CTE006.EID=CTE000.EID 
 LEFT OUTER JOIN CTE007 ON CTE007.EID=CTE000.EID 
 LEFT OUTER JOIN CTE008 ON CTE008.EID=CTE000.EID 
 LEFT OUTER JOIN CTE009 ON CTE009.EID=CTE000.EID 
 LEFT OUTER JOIN CTE010 ON CTE010.EID=CTE000.EID 
 LEFT OUTER JOIN CTE011 ON CTE011.EID=CTE000.EID 
 LEFT OUTER JOIN CTE012 ON CTE012.EID=CTE000.EID 
 LEFT OUTER JOIN CTE013 ON CTE013.EID=CTE000.EID 
 LEFT OUTER JOIN CTE014 ON CTE014.EID=CTE000.EID 
 LEFT OUTER JOIN CTE015 ON CTE015.EID=CTE000.EID 
 LEFT OUTER JOIN CTE016 ON CTE016.EID=CTE000.EID 
 LEFT OUTER JOIN CTE017 ON CTE017.EID=CTE000.EID 
 LEFT OUTER JOIN CTE018 ON CTE018.EID=CTE000.EID 
 LEFT OUTER JOIN CTE019 ON CTE019.EID=CTE000.EID 
 LEFT OUTER JOIN CTE020 ON CTE020.EID=CTE000.EID 
 LEFT OUTER JOIN CTE021 ON CTE021.EID=CTE000.EID 
 LEFT OUTER JOIN CTE022 ON CTE022.EID=CTE000.EID 
 LEFT OUTER JOIN CTE023 ON CTE023.EID=CTE000.EID 
;';
    dbms_output.put_line('->  ' || s);
    s:= TRANSLATE(s, '`', '''''');
    dbms_output.put_line('->  ' || s);
--EXECUTE IMMEDIATE s;

END;
