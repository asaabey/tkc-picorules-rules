WITH CTE000 AS (SELECT EID FROM EADV GROUP BY EID),CTE001 AS (SELECT EID,MAX(DT) AS hd_icd  FROM EADV WHERE (ATT = 'icd_Z49_1') GROUP BY EID),
CTE002 AS (SELECT EID,MAX(DT) AS hd_icpc  FROM EADV WHERE (ATT = 'U59001') OR (ATT = 'U59008') GROUP BY EID),
CTE003 AS (SELECT EID,MAX(DT) AS hd_proc  FROM EADV WHERE (ATT = '1310000') GROUP BY EID),
CTE004 AS (SELECT CASE WHEN 1=1 THEN coalesce(hd_icd,hd_icpc,hd_proc) END AS RRT_HD_LD,CTE000.EID  FROM CTE000 LEFT OUTER JOIN CTE001 ON CTE001.EID=CTE000.EID  LEFT OUTER JOIN CTE002 ON CTE002.EID=CTE000.EID  LEFT OUTER JOIN CTE003 ON CTE003.EID=CTE000.EID )
 SELECT CTE000.EID, CTE001.hd_icd 
,CTE002.hd_icpc 
,CTE003.hd_proc 
,CTE004.rrt_hd_ld 
FROM CTE000 LEFT OUTER JOIN CTE001 ON CTE001.EID=CTE000.EID 
 LEFT OUTER JOIN CTE002 ON CTE002.EID=CTE000.EID 
 LEFT OUTER JOIN CTE003 ON CTE003.EID=CTE000.EID 
 LEFT OUTER JOIN CTE004 ON CTE004.EID=CTE000.EID 
;