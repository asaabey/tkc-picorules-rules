WITH CTE000 AS (SELECT EID FROM EADV GROUP BY EID),CTE001 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE (ATT = 'eGFR')),
CTE002 AS (SELECT EID,VAL AS egfrlv FROM CTE001 WHERE rank=1),
CTE003 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE (ATT = 'ACR')),
CTE004 AS (SELECT EID,VAL AS acrlv FROM CTE003 WHERE rank=1),
CTE005 AS (SELECT EID,MAX(DT) AS egfrld  FROM EADV WHERE (ATT = 'eGFR') GROUP BY EID),
CTE006 AS (SELECT EID,MAX(DT) AS acrld  FROM EADV WHERE (ATT = 'ACR') GROUP BY EID),
CTE007 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE (ATT = 'SYSTOLIC')),
CTE008 AS (SELECT EID,VAL AS sbp_lv FROM CTE007 WHERE rank=1),
CTE009 AS (SELECT EID,DT,ROW_NUMBER() OVER(PARTITION BY EID ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE (ATT = 'U99034') OR (ATT = 'U99035') OR (ATT = 'U99036') OR (ATT = 'U99037') OR (ATT = 'U99038') OR (ATT = 'U99039')),
CTE010 AS (SELECT EID,DT AS LastCkdDiagICPC FROM CTE009 WHERE rank=1),
CTE011 AS (SELECT EID,MAX(DT) AS LastCkdDiagICD  FROM EADV WHERE (ATT LIKE 'icd_N18%') GROUP BY EID),
CTE012 AS (SELECT EID,MAX(DT) AS hd_icd  FROM EADV WHERE (ATT = 'icd_Z49_1') GROUP BY EID),
CTE013 AS (SELECT EID,MAX(DT) AS hd_icpc  FROM EADV WHERE (ATT = 'U59001') OR (ATT = 'U59008') GROUP BY EID),
CTE014 AS (SELECT EID,MAX(DT) AS hd_proc  FROM EADV WHERE (ATT = '1310000') GROUP BY EID),
CTE015 AS (SELECT EID,MAX(DT) AS pd_icpc  FROM EADV WHERE (ATT = 'U59007') OR (ATT = 'U59009') GROUP BY EID),
CTE016 AS (SELECT EID,MAX(DT) AS tx  FROM EADV WHERE (ATT LIKE 'icd_Z94%') OR (ATT = 'U28001') GROUP BY EID),
CTE017 AS (SELECT EID,MAX(DT) AS hhd  FROM EADV WHERE (ATT = 'U59J99') GROUP BY EID),
CTE018 AS (SELECT EID,MAX(DT) AS dm_icd  FROM EADV WHERE (ATT LIKE 'icd_E08%') OR (ATT LIKE 'icd_E09%') OR (ATT LIKE 'icd_E10%') OR (ATT LIKE 'icd_E11%') OR (ATT LIKE 'icd_E14%') GROUP BY EID),
CTE019 AS (SELECT EID,MAX(DT) AS dm_icpc  FROM EADV WHERE (ATT LIKE 'T89%') OR (ATT LIKE 'T90%') GROUP BY EID),
CTE020 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE (ATT = 'HBA1C_DFCC')),
CTE021 AS (SELECT EID,VAL AS hba1c FROM CTE020 WHERE rank=1),
CTE022 AS (SELECT CASE WHEN egfrlv>=90 THEN 'G1' WHEN egfrlv<90 AND egfrlv>=60 THEN 'G2' WHEN egfrlv<60 AND egfrlv>=45 THEN 'G3A' WHEN egfrlv<45 AND egfrlv>=30 THEN 'G3B' WHEN egfrlv<30 AND egfrlv>=15 THEN 'G4' WHEN egfrlv<15 THEN 'G5' ELSE 'NA' END AS CGA_G,CTE002.EID  FROM CTE002 INNER JOIN CTE004 ON CTE004.EID=CTE002.EID ),
CTE023 AS (SELECT CASE WHEN acrlv<3 THEN 'A1' WHEN acrlv<30 AND acrlv>=3 THEN 'A2' WHEN acrlv<300 AND acrlv>=30 THEN 'A3' WHEN acrlv>300 THEN 'A4' ELSE 'NA' END AS CGA_A,CTE004.EID  FROM CTE004)
 SELECT CTE000.EID, CTE002.egfrlv 
,CTE004.acrlv 
,CTE005.egfrld 
,CTE006.acrld 
,CTE008.sbp_lv 
,CTE010.LastCkdDiagICPC 
,CTE011.LastCkdDiagICD 
,CTE012.hd_icd 
,CTE013.hd_icpc 
,CTE014.hd_proc 
,CTE015.pd_icpc 
,CTE016.tx 
,CTE017.hhd 
,CTE018.dm_icd 
,CTE019.dm_icpc 
,CTE021.hba1c 
,CTE022.cga_g 
,CTE023.cga_a 
FROM CTE000 LEFT OUTER JOIN CTE002 ON CTE002.EID=CTE000.EID 
 LEFT OUTER JOIN CTE004 ON CTE004.EID=CTE000.EID 
 LEFT OUTER JOIN CTE005 ON CTE005.EID=CTE000.EID 
 LEFT OUTER JOIN CTE006 ON CTE006.EID=CTE000.EID 
 LEFT OUTER JOIN CTE008 ON CTE008.EID=CTE000.EID 
 LEFT OUTER JOIN CTE010 ON CTE010.EID=CTE000.EID 
 LEFT OUTER JOIN CTE011 ON CTE011.EID=CTE000.EID 
 LEFT OUTER JOIN CTE012 ON CTE012.EID=CTE000.EID 
 LEFT OUTER JOIN CTE013 ON CTE013.EID=CTE000.EID 
 LEFT OUTER JOIN CTE014 ON CTE014.EID=CTE000.EID 
 LEFT OUTER JOIN CTE015 ON CTE015.EID=CTE000.EID 
 LEFT OUTER JOIN CTE016 ON CTE016.EID=CTE000.EID 
 LEFT OUTER JOIN CTE017 ON CTE017.EID=CTE000.EID 
 LEFT OUTER JOIN CTE018 ON CTE018.EID=CTE000.EID 
 LEFT OUTER JOIN CTE019 ON CTE019.EID=CTE000.EID 
 LEFT OUTER JOIN CTE021 ON CTE021.EID=CTE000.EID 
 LEFT OUTER JOIN CTE022 ON CTE022.EID=CTE000.EID 
 LEFT OUTER JOIN CTE023 ON CTE023.EID=CTE000.EID 
;