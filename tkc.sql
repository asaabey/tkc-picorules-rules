with 
CTE005 AS (SELECT EID,DT,ROW_NUMBER() OVER(PARTITION BY EID,ATT ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE ATT =('Z49_1')),
CTE006 AS (SELECT EID,DT AS hdld FROM CTE005 WHERE rank=1)
SELECT * FROM cte006;

WITH CTE000 AS (SELECT EID FROM EADV GROUP BY EID),CTE001 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID,ATT ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE ATT=('eGFR')),
CTE002 AS (SELECT EID,VAL AS egfrl FROM CTE001 WHERE rank=1),
CTE003 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID,ATT ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE ATT=('ACR')),
CTE004 AS (SELECT EID,VAL AS acrl FROM CTE003 WHERE rank=1),
CTE005 AS (SELECT EID,DT,ROW_NUMBER() OVER(PARTITION BY EID,ATT ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE ATT LIKE('Z49_%')),
CTE006 AS (SELECT EID,DT AS hdld FROM CTE005 WHERE rank=1),
CTE007 AS (SELECT EID,VAL,ROW_NUMBER() OVER(PARTITION BY EID,ATT ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE ATT=('SYSTOLIC')),
CTE008 AS (SELECT EID,VAL AS sbp_lv FROM CTE007 WHERE rank=1),
CTE009 AS (SELECT EID,DT,ROW_NUMBER() OVER(PARTITION BY EID,ATT ORDER BY EID,DT DESC) AS rank  FROM EADV WHERE ATT IN('U88093','U95008','U95004')),
CTE010 AS (SELECT EID,DT AS cong_icpc2p FROM CTE009 WHERE rank=1),
CTE011 AS (SELECT CASE WHEN egfrl>=90 AND acrl>30 THEN '1' WHEN egfrl<90 AND egfrl>=60  AND acrl>30 THEN '2' WHEN egfrl<60 AND egfrl>=45 THEN '3b' WHEN egfrl<45 AND egfrl>=30 THEN '3a' WHEN egfrl<30 AND egfrl>=15 THEN '4' WHEN egfrl<15 THEN '5' END AS CKDSTAGE,CTE002.EID  FROM CTE002 INNER JOIN CTE004 ON CTE004.EID=CTE002.EID )
 SELECT CTE000.EID, CTE002.egfrl 
,CTE004.acrl 
,CTE006.hdld 
,CTE008.sbp_lv 
,CTE010.cong_icpc2p 
,CTE011.ckdstage 
FROM CTE000 LEFT OUTER JOIN CTE002 ON CTE002.EID=CTE000.EID 
 LEFT OUTER JOIN CTE004 ON CTE004.EID=CTE000.EID 
 LEFT OUTER JOIN CTE006 ON CTE006.EID=CTE000.EID 
 LEFT OUTER JOIN CTE008 ON CTE008.EID=CTE000.EID 
 LEFT OUTER JOIN CTE010 ON CTE010.EID=CTE000.EID 
 LEFT OUTER JOIN CTE011 ON CTE011.EID=CTE000.EID 
;