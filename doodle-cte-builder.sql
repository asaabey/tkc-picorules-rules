
WITH
CTE1 AS (SELECT eid,val,ROW_NUMBER() OVER(PARTITION BY eid,att ORDER BY eid,dt desc) AS rank
FROM EADV
WHERE ATT='DIASTOLIC' 
)
SELECT val FROM CTE1
WHERE rank=1

;
WITH CTE00000 AS (SELECT EID FROM EADV GROUP BY EID),
cte00001 AS (SELECT EID,MAX(VAL) AS MAXVAL,MIN(VAL) AS MINVAL FROM EADV WHERE ATT='eGFR' GROUP BY ATT,EID),
cte00002 AS (SELECT EID,MAX(VAL) AS MAXVAL,MIN(VAL) AS MINVAL FROM EADV WHERE ATT='ACR' GROUP BY ATT,EID),
cte00003 AS (SELECT EID,MAX(VAL) AS MAXVAL,MIN(VAL) AS MINVAL FROM EADV WHERE ATT='Albumin' GROUP BY ATT,EID),
cte00004 AS (SELECT eid,val,ROW_NUMBER() OVER(PARTITION BY eid,att ORDER BY eid,dt desc) AS rank FROM EADV WHERE ATT='DIASTOLIC') 
SELECT CTE00000.EID, cte00001.* ,cte00002.* ,cte00003.* ,cte00004.* 
FROM CTE00000 
LEFT OUTER JOIN cte00001 ON cte00001.EID=CTE00000.EID 
LEFT OUTER JOIN cte00002 ON cte00002.EID=CTE00000.EID 
LEFT OUTER JOIN cte00003 ON cte00003.EID=CTE00000.EID 
LEFT OUTER JOIN cte00004 ON cte00004.EID=CTE00000.EID ;


